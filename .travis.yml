language: cpp
if: tag IS blank
matrix:
    include:
        - os: osx
          osx_image: xcode9.2
          compiler: clang

install:
    - cd ..
    - git clone https://github.com/chibidev/git-dependencies.git
    - export PATH=$PATH:`pwd`/git-dependencies
    - cd reflgen
    - brew upgrade python
    - brew install llvm
    - export LLVM_CONFIG=`find /usr/local/Cellar -name llvm-config`

script:
    - git-dependencies update -r
    - mkdir build && cd build
    - cmake -D LLVM_VERSION_EXPLICIT=`clang -v 2>&1 | grep version | cut -d ' ' -f 4` -D LIBCLANG_INCLUDE_DIR=`$LLVM_CONFIG --includedir` -D LIBCLANG_LIBRARY=/Applications/Xcode.app/Contents/Frameworks/libclang.dylib -D CLANG_BINARY=/usr/bin/clang -D LIBCLANG_SYSTEM_INCLUDE_DIR=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.13.sdk -D CMAKE_BUILD_TYPE=Release ..
    - cmake --build . --target reflgen

before_deploy:
    - cd $TRAVIS_BUILD_DIR
    - export RELEASE_TAG=v`cat src/main.cpp | grep version | grep static | cut -d '"' -f 2`

deploy:
    provider: releases
    api_key:
        secure: LyhadJ31ds0bTQAZ+aLWGPVj35VAxYN3I4rIvjGuPmMYhkELKrKkVZFRQKGvGff8V7VIHMO5FTZG7YCKeYkohI+Xxp2Od7LUVAMfA32v4bW7tJ6qNkExm6g63jNwK1Kk8DAeGvnsDNHrabYsdWmH10NDJWk7k0LoYSU/EWVF6Ih+F9LPCi/roW1V2Kal97/++YwEGkn5A2yGmt09ayPvGUWCk3KVHeogqPZfPDIwB7G1IUVukTjIUPFSyf2Pf6tEh1GdVtyvh74wCJWtYdISZUy+sFhRRKyyqB3Lk8Gzyn20a6+Ftttxn+jhojkZaYzg6jWElE94WZi0186mZiZ7IuzzfI6m2tSw8pK7QC7O+1zC6clDzMUI25d8qna9nkv6V5K81rVsHzaMwRJ2Tz1VoeOm+HhjbpizOpp3z1T/y9lextYgsxjTeNS7n1+YwQeoVuVsdxAYCoyEmlmo/pouEyIx818Y/umWVZvRt+Q84ItUa5N6PlfOr/QvNzA/DjcCGQBC7ZPEsOKHFEYKcYwLIHUJOGdrWrogxuKcGJtM8rgFYRx+wGOwziAFsWB+88vzY+oVvNE34VhOCFMTS/wajPAX/IEPwBnN4ZauxoyFeghXoi9GlkWZfMdXWsWHKcmjTi7y1hleVlGtlH2ikhxehtGNiqX0wBXulQeiZuIt5bY=
    file: $TRAVIS_BUILD_DIR/build/reflgen
    skip_cleanup: true
    draft: false
    tag_name: $RELEASE_TAG
    name: reflgen macOS $RELEASE_TAG
    on:
        repo: chibidev/reflgen
        branch: master

